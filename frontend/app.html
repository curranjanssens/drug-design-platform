<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Design Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .advanced-bg { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Smooth progress bar */
        .progress-bar-animated {
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 300% 100%;
            animation: progressShimmer 2s ease infinite;
        }
        @keyframes progressShimmer {
            0% { background-position: 100% 0; }
            100% { background-position: 0 0; }
        }
        /* Streaming candidate flash animation */
        .animate-pulse-once {
            animation: pulseOnce 1s ease-out;
        }
        @keyframes pulseOnce {
            0% { background-color: rgba(34, 197, 94, 0.3); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">
                Drug Design Platform
            </h1>
            <p class="text-gray-400 text-lg">AI-powered molecular design for drug discovery</p>
            <div id="status" class="mt-4 text-sm"></div>
        </header>

        <!-- Main Input -->
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 mb-8">
            <label class="block text-lg font-medium text-gray-300 mb-4">
                What would you like to design?
            </label>
            <textarea id="prompt" rows="4"
                class="w-full bg-gray-700 border border-gray-600 rounded-xl p-4 text-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                placeholder="Example: Design a selective EGFR T790M kinase inhibitor for non-small cell lung cancer"></textarea>

            <!-- Quick Prompts -->
            <div class="mt-4 mb-6">
                <p class="text-sm text-gray-500 mb-2">Try these examples:</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="loadPrompt('egfr')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        EGFR T790M Inhibitor
                    </button>
                    <button onclick="loadPrompt('kk103')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        KK103 Analogue
                    </button>
                    <button onclick="loadPrompt('5ht')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        5HT1A-5HT2A Bivalent
                    </button>
                    <button onclick="loadPrompt('antibiotic')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        Novel Antibiotic
                    </button>
                    <button onclick="loadPrompt('faah')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        PF-04457845 Analogue
                    </button>
                </div>
            </div>

            <!-- Design Mode Toggle -->
            <div class="mb-6 p-4 bg-gray-700/50 rounded-xl">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-gray-300 font-medium">Design Mode</span>
                    <div class="flex gap-2">
                        <button id="modeQuick" onclick="setMode('quick')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all gradient-bg text-white">
                            Quick (~5s)
                        </button>
                        <button id="modeAdvanced" onclick="setMode('advanced')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-600 text-gray-300 hover:bg-gray-500">
                            Advanced (~2min)
                        </button>
                    </div>
                </div>
                <p id="modeDescription" class="text-sm text-gray-400">
                    Fast design using pattern-based generation. Good for initial exploration.
                </p>
            </div>

            <!-- Submit Button -->
            <button onclick="submitDesign()" id="submitBtn"
                class="w-full gradient-bg text-white py-4 px-6 rounded-xl text-lg font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all">
                Design Novel Molecules
            </button>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">Design Results</h2>
                    <span id="jobStatus" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>

                <!-- Strategy (for advanced mode) -->
                <div id="strategySection" class="hidden mb-6 p-4 bg-indigo-900/30 border border-indigo-700 rounded-xl">
                    <h3 class="text-indigo-300 font-semibold mb-2">Design Strategy</h3>
                    <p id="strategyText" class="text-gray-300 text-sm"></p>
                </div>

                <!-- Progress -->
                <div id="progressSection" class="mb-6">
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span id="currentStep">Initializing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="h-3 rounded-full progress-bar-animated transition-all duration-300 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Live Narrative Feed -->
                <div id="liveFeedSection" class="hidden mb-6">
                    <div class="bg-gray-900/50 border border-gray-700 rounded-xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <h3 class="text-sm font-semibold text-gray-300">Live Feed</h3>
                        </div>
                        <div id="narrativeFeed" class="space-y-2 max-h-48 overflow-y-auto text-sm">
                            <!-- Narrative updates appear here -->
                        </div>
                    </div>
                </div>

                <!-- Streaming Verified Candidates (shows as they pass verification) -->
                <div id="streamingCandidatesSection" class="hidden mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <h3 class="text-lg font-semibold text-gray-300">Verified Candidates</h3>
                        <span id="verifiedCount" class="text-sm text-gray-500">(0 verified)</span>
                    </div>
                    <div id="streamingCandidatesList" class="space-y-3"></div>
                </div>

                <!-- Molecules List (final results) -->
                <div id="moleculesSection" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-300 mb-4">Final Ranked Results</h3>
                    <div id="moleculesList" class="space-y-4"></div>
                </div>

                <!-- Error Message -->
                <div id="errorSection" class="hidden">
                    <div class="bg-red-900/50 border border-red-700 rounded-lg p-4">
                        <p id="errorMessage" class="text-red-400"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // Empty for relative paths - nginx proxies /api/ to backend
        let currentMode = 'quick';
        let currentJobId = null;
        let pollInterval = null;

        const PROMPTS = {
            egfr: "Design a selective kinase inhibitor targeting EGFR T790M mutation with improved selectivity over wild-type EGFR for treating non-small cell lung cancer. Include a covalent warhead for irreversible binding to Cys797.",
            kk103: "Design a novel, patentable analogue of KK103 (N-pivaloyl-Leu-Enkephalin) with improved metabolic stability for treating chronic pain. The compound should target delta opioid receptors.",
            '5ht': "Design a novel dual 5HT1A-5HT2A agonist bivalent ligand with CNS penetration for treating depression and anxiety. The molecule should cross the blood-brain barrier.",
            antibiotic: "Design a novel antibiotic compound effective against gram-negative bacteria with a new mechanism of action to combat antibiotic resistance.",
            faah: "Design a novel, patentable version of PF-04457845, a FAAH (fatty acid amide hydrolase) inhibitor. Maintain the piperidine amide core and urea warhead mechanism for Ser241 carbamylation, but modify for improved properties and novelty."
        };

        const MODE_DESCRIPTIONS = {
            quick: "Fast design using pattern-based generation. Good for initial exploration.",
            advanced: "Agentic AI design with iterative optimization. Claude analyzes the target, plans strategy, and refines candidates over multiple iterations. Best for serious candidates."
        };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeQuick').className = mode === 'quick'
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all gradient-bg text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-600 text-gray-300 hover:bg-gray-500';
            document.getElementById('modeAdvanced').className = mode === 'advanced'
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all advanced-bg text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-600 text-gray-300 hover:bg-gray-500';
            document.getElementById('modeDescription').textContent = MODE_DESCRIPTIONS[mode];
            document.getElementById('submitBtn').className = mode === 'advanced'
                ? 'w-full advanced-bg text-white py-4 px-6 rounded-xl text-lg font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all'
                : 'w-full gradient-bg text-white py-4 px-6 rounded-xl text-lg font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all';
        }

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.status === 'healthy') {
                    statusDiv.innerHTML = '<span class="inline-flex items-center text-green-400"><span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>System Online</span>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<span class="inline-flex items-center text-red-400"><span class="w-2 h-2 bg-red-400 rounded-full mr-2"></span>Backend Offline - Start server on port 8000</span>';
            }
        }

        function loadPrompt(key) {
            document.getElementById('prompt').value = PROMPTS[key] || '';
            // Auto-select advanced mode for complex targets
            if (key === 'egfr' || key === 'faah' || key === 'kk103') {
                setMode('advanced');
            }
        }

        async function submitDesign() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('Please enter a design request');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;

            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('moleculesSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('strategySection').classList.add('hidden');

            if (currentMode === 'advanced') {
                await submitAdvancedDesign(prompt, btn);
            } else {
                await submitQuickDesign(prompt, btn);
            }
        }

        async function submitQuickDesign(prompt, btn) {
            btn.innerHTML = '<span class="loading">Designing...</span>';
            updateProgress(0, 'Submitting request...');
            updateJobStatus('pending');

            try {
                const res = await fetch(`${API_BASE}/api/v1/design`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to submit job');
                }

                const data = await res.json();
                currentJobId = data.job_id;
                updateProgress(5, 'Job submitted, starting design...');
                updateJobStatus(data.status);
                startPolling(data.job_id);

            } catch (e) {
                showError(e.message);
                resetButton();
            }
        }

        function addNarrativeUpdate(phase, message, isNarrative = false) {
            const feed = document.getElementById('narrativeFeed');
            const phaseIcons = {
                starting: 'ðŸš€',
                research: 'ðŸ”¬',
                chembl: 'ðŸ“Š',
                references: 'ðŸ“š',
                mechanism: 'âš—ï¸',
                strategy: 'ðŸ“‹',
                scoring: 'ðŸ“ˆ',
                design: 'ðŸ§¬',
                validation: 'âœ…',
                selection: 'ðŸ†',
                completed: 'âœ¨',
                error: 'âŒ'
            };
            const phaseColors = {
                research: 'text-blue-400',
                chembl: 'text-purple-400',
                references: 'text-indigo-400',
                mechanism: 'text-pink-400',
                strategy: 'text-yellow-400',
                scoring: 'text-orange-300',
                design: 'text-green-400',
                validation: 'text-orange-400',
                selection: 'text-cyan-400',
                completed: 'text-green-300',
                error: 'text-red-400'
            };
            const color = phaseColors[phase] || 'text-gray-400';
            const icon = phaseIcons[phase] || 'â€¢';
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Truncate long messages
            const displayMessage = message.length > 120 ? message.substring(0, 117) + '...' : message;

            const entry = document.createElement('div');
            entry.className = `flex gap-2 items-start ${isNarrative ? 'bg-indigo-900/30 border-l-2 border-indigo-500 rounded px-2 py-1' : 'py-0.5'}`;
            entry.innerHTML = `
                <span class="text-gray-600 flex-shrink-0 text-xs">${timestamp}</span>
                <span class="flex-shrink-0">${icon}</span>
                <span class="${color} ${isNarrative ? 'font-medium' : ''}">${displayMessage}</span>
            `;
            feed.insertBefore(entry, feed.firstChild);

            // Keep only last 30 entries for performance
            while (feed.children.length > 30) {
                feed.removeChild(feed.lastChild);
            }

            // Auto-scroll to show newest
            feed.scrollTop = 0;
        }

        let streamingCandidateCount = 0;

        function addVerifiedCandidate(candidate) {
            // Show the streaming section
            const section = document.getElementById('streamingCandidatesSection');
            section.classList.remove('hidden');

            streamingCandidateCount++;
            document.getElementById('verifiedCount').textContent = `(${streamingCandidateCount} verified)`;

            const list = document.getElementById('streamingCandidatesList');
            const props = candidate.properties || {};

            const card = document.createElement('div');
            card.className = 'bg-gray-700/50 border border-green-500/30 rounded-lg p-3 animate-pulse-once';
            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-green-400 font-semibold">${candidate.name}</span>
                            ${candidate.warnings && candidate.warnings.length > 0 ?
                                `<span class="text-xs text-yellow-400">âš  ${candidate.warnings.length} warning${candidate.warnings.length > 1 ? 's' : ''}</span>` : ''}
                        </div>
                        ${candidate.rationale ? `<p class="text-xs text-gray-400 mb-2">${candidate.rationale.substring(0, 100)}${candidate.rationale.length > 100 ? '...' : ''}</p>` : ''}
                        <div class="flex gap-3 text-xs text-gray-500">
                            <span>MW: ${props.mw ? props.mw.toFixed(0) : '?'}</span>
                            <span>LogP: ${props.logp ? props.logp.toFixed(1) : '?'}</span>
                            <span>TPSA: ${props.tpsa ? props.tpsa.toFixed(0) : '?'}</span>
                        </div>
                        <div class="font-mono text-xs text-gray-500 mt-2 bg-gray-800 p-1 rounded overflow-x-auto">
                            ${candidate.smiles}
                        </div>
                    </div>
                </div>
            `;

            // Add to top of list
            list.insertBefore(card, list.firstChild);

            // Flash animation then settle
            setTimeout(() => {
                card.classList.remove('animate-pulse-once');
                card.classList.add('border-gray-600');
                card.classList.remove('border-green-500/30');
            }, 1000);
        }

        async function submitAdvancedDesign(prompt, btn) {
            btn.innerHTML = '<svg class="inline w-5 h-5 mr-2 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Running Advanced Design...';
            updateProgress(5, 'Starting design process...');
            updateJobStatus('running');

            // Reset streaming candidates
            streamingCandidateCount = 0;
            document.getElementById('streamingCandidatesSection').classList.add('hidden');
            document.getElementById('streamingCandidatesList').innerHTML = '';
            document.getElementById('verifiedCount').textContent = '(0 verified)';

            // Show and clear live feed
            document.getElementById('liveFeedSection').classList.remove('hidden');
            document.getElementById('narrativeFeed').innerHTML = '';

            // Try streaming endpoint first, fall back to regular endpoint
            try {
                const response = await fetch(`${API_BASE}/api/v1/design/advanced/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    throw new Error('Streaming not available');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let finalData = null;
                let currentProgress = 5;
                let designIteration = 0;
                let maxIterations = 10;

                // Phase progress ranges - design phase spans 55-90% based on iterations
                function getPhaseProgress(phase, data) {
                    const baseProgress = {
                        starting: 5,
                        research: 15,
                        chembl: 25,
                        references: 35,
                        mechanism: 45,
                        strategy: 50,
                        scoring: 55,
                        selection: 92,
                        completed: 100,
                        error: 100
                    };

                    if (phase === 'design') {
                        // Design phase: 55% to 90% based on iteration
                        if (data && data.iteration) {
                            designIteration = data.iteration;
                            maxIterations = data.total || 10;
                        }
                        // Smoothly progress through design iterations
                        const designStart = 55;
                        const designEnd = 90;
                        const iterProgress = designIteration / maxIterations;
                        return designStart + (designEnd - designStart) * iterProgress;
                    }

                    if (phase === 'validation') {
                        // Validation happens during design, slight bump
                        return currentProgress + 1;
                    }

                    return baseProgress[phase] || currentProgress + 2;
                }

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.substring(6));
                                currentProgress = getPhaseProgress(event.phase, event.data);
                                updateProgress(currentProgress, event.message);

                                // Add to narrative feed
                                const isNarrative = event.data && event.data.narrative;
                                addNarrativeUpdate(event.phase, event.message, isNarrative);

                                // STREAMING: Show verified candidates as they come in
                                if (event.data && event.data.verified_candidate) {
                                    addVerifiedCandidate(event.data.verified_candidate);
                                }

                                if (event.phase === 'completed') {
                                    finalData = event.data;
                                } else if (event.phase === 'error') {
                                    throw new Error(event.message);
                                }
                            } catch (parseErr) {
                                console.warn('Failed to parse SSE event:', parseErr);
                            }
                        }
                    }
                }

                if (finalData) {
                    updateProgress(100, 'Design complete!');
                    updateJobStatus('completed');
                    // Display the results directly from stream data
                    displayStreamResults(finalData);
                }

            } catch (streamErr) {
                console.log('Streaming failed, using regular endpoint:', streamErr.message);
                // Fall back to non-streaming endpoint
                try {
                    const res = await fetch(`${API_BASE}/api/v1/design/advanced`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.detail || 'Advanced design failed');
                    }

                    const data = await res.json();
                    updateProgress(100, 'Design complete!');
                    updateJobStatus('completed');
                    displayAdvancedResults(data);

                } catch (e) {
                    showError(e.message);
                }
            } finally {
                resetButton();
            }
        }

        function startPolling(jobId) {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/v1/design/${jobId}`);
                    if (!res.ok) throw new Error('Failed to fetch job status');

                    const job = await res.json();
                    updateProgress(job.progress * 100, job.current_step || 'Processing...');
                    updateJobStatus(job.status);

                    if (job.status === 'completed') {
                        clearInterval(pollInterval);
                        displayQuickResults(job);
                        resetButton();
                    } else if (job.status === 'failed') {
                        clearInterval(pollInterval);
                        showError(job.error_message || 'Job failed');
                        resetButton();
                    }
                } catch (e) {
                    console.error('Polling error:', e);
                }
            }, 2000);
        }

        function updateProgress(percent, step) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
            document.getElementById('currentStep').textContent = step;
        }

        function updateJobStatus(status) {
            const el = document.getElementById('jobStatus');
            const colors = {
                pending: 'bg-yellow-600 text-yellow-100',
                running: 'bg-blue-600 text-blue-100',
                completed: 'bg-green-600 text-green-100',
                failed: 'bg-red-600 text-red-100'
            };
            el.className = `px-3 py-1 rounded-full text-sm font-medium ${colors[status] || 'bg-gray-600'}`;
            el.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function displayStreamResults(data) {
            // Display results from stream data (different format than full API response)
            const strategySection = document.getElementById('strategySection');
            strategySection.classList.remove('hidden');

            let targetHtml = '';
            if (data.target) {
                targetHtml += `<div class="mb-3">
                    <span class="text-indigo-400 font-semibold">Target:</span>
                    <span class="text-white ml-2">${data.target}</span>
                    ${data.target_type ? `<span class="text-gray-400 ml-2">(${data.target_type})</span>` : ''}
                </div>`;
            }

            if (data.mechanism) {
                targetHtml += `<div class="mb-3">
                    <span class="text-indigo-400 font-semibold">Mechanism:</span>
                    <span class="text-gray-300 ml-2">${data.mechanism}</span>
                </div>`;
            }

            // Only show binding type for actual inhibitors (not releasers/substrates)
            if (data.is_covalent !== undefined && data.mechanism) {
                const mech = data.mechanism.toLowerCase();
                // Don't show "Type" for releasers, substrates, or agonists - their mechanism already explains it
                if (!mech.includes('releaser') && !mech.includes('substrate') && !mech.includes('agonist')) {
                    targetHtml += `<div class="mb-3">
                        <span class="text-pink-400 font-semibold">Binding:</span>
                        <span class="text-gray-300 ml-2">${data.is_covalent ? 'Covalent (irreversible)' : 'Reversible'}</span>
                    </div>`;
                }
            }

            document.getElementById('strategyText').innerHTML = targetHtml || '<p class="text-gray-400">Design completed</p>';

            // Display candidates
            document.getElementById('moleculesSection').classList.remove('hidden');
            const list = document.getElementById('moleculesList');

            const candidates = data.candidates || [];
            if (candidates.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No molecules generated. Check the design log for details.</p>';
                return;
            }

            list.innerHTML = candidates.map((mol, i) => `
                <div class="bg-gray-700 rounded-xl p-4 hover:bg-gray-650 transition-colors border-l-4 ${i < 3 ? 'border-pink-500' : 'border-gray-600'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-xl font-bold ${i < 3 ? 'text-pink-400' : 'text-indigo-400'}">#${mol.rank || i + 1}</span>
                                <span class="font-medium text-white">${mol.name || 'Candidate'}</span>
                                <span class="px-2 py-1 bg-pink-600/30 text-pink-300 rounded text-xs">
                                    ${((mol.score || 0) * 100).toFixed(0)}%
                                </span>
                            </div>
                            ${mol.rationale ? `<p class="text-sm text-gray-400 mb-2">${mol.rationale}</p>` : ''}
                            <div class="font-mono text-xs text-gray-400 bg-gray-800 p-2 rounded overflow-x-auto">
                                ${mol.smiles || 'SMILES not available'}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayQuickResults(job) {
            document.getElementById('moleculesSection').classList.remove('hidden');
            const list = document.getElementById('moleculesList');

            if (!job.molecules || job.molecules.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No molecules generated</p>';
                return;
            }

            list.innerHTML = job.molecules.map((mol, i) => `
                <div class="bg-gray-700 rounded-xl p-4 hover:bg-gray-650 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-xl font-bold text-indigo-400">#${i + 1}</span>
                                <span class="px-2 py-1 bg-indigo-600/30 text-indigo-300 rounded text-xs">
                                    Score: ${((mol.score || 0) * 100).toFixed(0)}%
                                </span>
                                ${mol.novelty?.patentable ? '<span class="px-2 py-1 bg-green-600/30 text-green-300 rounded text-xs">Patentable</span>' : ''}
                            </div>
                            <div class="font-mono text-xs text-gray-400 bg-gray-800 p-2 rounded overflow-x-auto">
                                ${mol.smiles || 'SMILES not available'}
                            </div>
                        </div>
                    </div>
                    ${mol.properties ? `
                    <div class="mt-3 grid grid-cols-4 gap-2 text-center">
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">MW</div>
                            <div class="font-semibold">${mol.properties.molecular_weight?.toFixed(0) || 'N/A'}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">LogP</div>
                            <div class="font-semibold">${mol.properties.logp?.toFixed(1) || 'N/A'}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">QED</div>
                            <div class="font-semibold">${mol.properties.qed?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">TPSA</div>
                            <div class="font-semibold">${mol.novelty?.tanimoto_similarity?.toFixed(2) || 'N/A'}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function displayAdvancedResults(data) {
            // Show target knowledge
            const strategySection = document.getElementById('strategySection');
            strategySection.classList.remove('hidden');

            let targetHtml = '';
            if (data.target) {
                targetHtml += `<div class="mb-3">
                    <span class="text-indigo-400 font-semibold">Target:</span>
                    <span class="text-white ml-2">${data.target}</span>
                    ${data.target_type ? `<span class="text-gray-400 ml-2">(${data.target_type})</span>` : ''}
                </div>`;
            }

            if (data.mechanism) {
                targetHtml += `<div class="mb-3">
                    <span class="text-indigo-400 font-semibold">Mechanism:</span>
                    <span class="text-gray-300 ml-2">${data.mechanism}</span>
                </div>`;
            }

            if (data.essential_features && data.essential_features.length > 0) {
                targetHtml += `<div class="mb-3">
                    <span class="text-green-400 font-semibold">Essential Features:</span>
                    <div class="flex flex-wrap gap-1 mt-1">${data.essential_features.map(f =>
                        `<span class="px-2 py-1 bg-green-900/50 text-green-300 rounded text-xs">${f}</span>`
                    ).join('')}</div>
                </div>`;
            }

            if (data.avoid_features && data.avoid_features.length > 0) {
                targetHtml += `<div class="mb-3">
                    <span class="text-red-400 font-semibold">Avoid:</span>
                    <div class="flex flex-wrap gap-1 mt-1">${data.avoid_features.map(f =>
                        `<span class="px-2 py-1 bg-red-900/50 text-red-300 rounded text-xs">${f}</span>`
                    ).join('')}</div>
                </div>`;
            }

            if (data.reference_compounds && data.reference_compounds.length > 0) {
                targetHtml += `<div class="mb-3">
                    <span class="text-purple-400 font-semibold">Reference Compounds:</span>
                    <div class="mt-1 space-y-1">${data.reference_compounds.map(ref =>
                        `<div class="text-xs">
                            <span class="text-purple-300">${ref.name}:</span>
                            <span class="font-mono text-gray-400 ml-1">${ref.smiles?.substring(0, 50)}${ref.smiles?.length > 50 ? '...' : ''}</span>
                        </div>`
                    ).join('')}</div>
                </div>`;
            }

            if (data.strategy) {
                targetHtml += `<div class="mt-4 pt-3 border-t border-indigo-700/50">
                    <span class="text-indigo-300 font-semibold">Strategy:</span>
                    <p class="text-gray-300 text-sm mt-1">${data.strategy}</p>
                </div>`;
            }

            // Add summary info to strategy section
            if (data.iterations) {
                targetHtml += `<div class="mt-3 text-sm text-gray-500">
                    Completed ${data.iterations} iterations | ${data.converged ? 'Converged' : 'Max iterations reached'} | Runtime: ${(data.runtime_seconds || 0).toFixed(0)}s
                </div>`;
            }

            document.getElementById('strategyText').innerHTML = targetHtml;

            document.getElementById('moleculesSection').classList.remove('hidden');
            const list = document.getElementById('moleculesList');

            if (!data.candidates || data.candidates.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No molecules generated</p>';
                return;
            }

            list.innerHTML = data.candidates.map((mol, i) => `
                <div class="bg-gray-700 rounded-xl p-4 hover:bg-gray-650 transition-colors border-l-4 ${i < 3 ? 'border-pink-500' : 'border-gray-600'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-xl font-bold ${i < 3 ? 'text-pink-400' : 'text-indigo-400'}">#${mol.rank}</span>
                                <span class="font-medium text-white">${mol.name || 'Candidate'}</span>
                                <span class="px-2 py-1 bg-pink-600/30 text-pink-300 rounded text-xs">
                                    ${(mol.scores.overall * 100).toFixed(0)}%
                                </span>
                                ${mol.patentable ? '<span class="px-2 py-1 bg-green-600/30 text-green-300 rounded text-xs">Patentable</span>' : ''}
                            </div>
                            ${mol.rationale ? `<p class="text-sm text-gray-400 mb-2">${mol.rationale}</p>` : ''}
                            <div class="font-mono text-xs text-gray-400 bg-gray-800 p-2 rounded overflow-x-auto">
                                ${mol.smiles}
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-6 gap-2 text-center">
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">MW</div>
                            <div class="font-semibold">${mol.properties.molecular_weight}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">LogP</div>
                            <div class="font-semibold">${mol.properties.logp}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">TPSA</div>
                            <div class="font-semibold">${mol.properties.tpsa}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">QED</div>
                            <div class="font-semibold">${mol.properties.qed}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">Binding</div>
                            <div class="font-semibold text-green-400">${(mol.scores.binding * 100).toFixed(0)}%</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-500">ADMET</div>
                            <div class="font-semibold text-blue-400">${(mol.scores.admet * 100).toFixed(0)}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showError(message) {
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function resetButton() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.textContent = 'Design Novel Molecules';
            if (currentMode === 'advanced') {
                btn.className = 'w-full advanced-bg text-white py-4 px-6 rounded-xl text-lg font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all';
            } else {
                btn.className = 'w-full gradient-bg text-white py-4 px-6 rounded-xl text-lg font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all';
            }
        }

        // Initialize
        checkStatus();
    </script>
</body>
</html>
